<div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-50">
    <div class="container mx-auto px-4 py-8 max-w-7xl">

        <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-50 p-6">
            <header class="mb-8">
                <div class="flex items-center gap-4 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-wheat w-10 h-10 text-amber-600">
                        <path d="M2 22 16 8"></path>
                        <path d="M3.47 12.53 5 11l1.53 1.53a3.5 3.5 0 0 1 0 4.94L5 19l-1.53-1.53a3.5 3.5 0 0 1 0-4.94Z">
                        </path>
                        <path d="M7.47 8.53 9 7l1.53 1.53a3.5 3.5 0 0 1 0 4.94L9 15l-1.53-1.53a3.5 3.5 0 0 1 0-4.94Z">
                        </path>
                        <path
                            d="M11.47 4.53 13 3l1.53 1.53a3.5 3.5 0 0 1 0 4.94L13 11l-1.53-1.53a3.5 3.5 0 0 1 0-4.94Z">
                        </path>
                        <path d="M20 2h2v2a4 4 0 0 1-4 4h-2V6a4 4 0 0 1 4-4Z"></path>
                        <path
                            d="M11.47 17.47 13 19l-1.53 1.53a3.5 3.5 0 0 1-4.94 0L5 19l1.53-1.53a3.5 3.5 0 0 1 4.94 0Z">
                        </path>
                        <path
                            d="M15.47 13.47 17 15l-1.53 1.53a3.5 3.5 0 0 1-4.94 0L9 15l1.53-1.53a3.5 3.5 0 0 1 4.94 0Z">
                        </path>
                        <path
                            d="M19.47 9.47 21 11l-1.53 1.53a3.5 3.5 0 0 1-4.94 0L13 11l1.53-1.53a3.5 3.5 0 0 1 4.94 0Z">
                        </path>
                    </svg>
                    <h1 class="text-4xl font-bold text-gray-800">Система подсчёта мешков муки</h1>
                </div>
                <p class="text-gray-600 ml-14">Автоматический подсчёт с использованием компьютерного зрения</p>
            </header>




            <!-- Кнопка старт — показывается, если форма скрыта -->
            @if (!creatingCycle && !activeCycle) {
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-clock w-6 h-6 text-gray-400">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Цикл подсчёта</h3>
                            <p class="text-sm text-gray-500">
                                {{ activeCycle ? 'Активен' : 'Нет активного цикла' }}
                            </p>
                        </div>
                    </div>
                    <button (click)="showCreateCycle()"
                        class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors flex items-center gap-2">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-play-circle w-5 h-5">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polygon points="10 8 16 12 10 16 10 8"></polygon>
                        </svg>
                        Начать новый цикл
                    </button>
                </div>
            </div>
            }

            <!-- ФОРМА создания цикла -->
            @if (creatingCycle && !activeCycle) {
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4 w-full">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-clock w-6 h-6 text-green-600">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>

                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Название цикла (например: 1500 шт Зерновой край)
                            </label>

                            <input type="text" [(ngModel)]="newCycle.cycleName" placeholder="Введите название цикла"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg
                     focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
                        </div>

                        <button [disabled]="newCycle.cycleName.trim() === ''" (click)="startCycle()" class="bg-green-600 hover:bg-green-700 disabled:bg-gray-400
                     text-white font-semibold py-2 px-6 rounded-lg transition-colors">
                            Начать
                        </button>

                        <button (click)="cancelCreateCycle()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold
                     py-2 px-4 rounded-lg transition-colors">
                            Отмена
                        </button>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-3 mb-4">
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Камера</label>

                        <!-- Кнопка открытия -->
                        <div (click)="openCameraDropdown = !openCameraDropdown"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white cursor-pointer flex justify-between items-center">
                            <span class="text-sm">
                                {{ selected_camera.rtsp.length ? selected_camera.rtsp.length + ' выбрано' : 'Выберите
                                камеру' }}
                            </span>
                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>

                        <!-- Dropdown -->
                        @if (openCameraDropdown){
                        <div
                            class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg max-h-60 overflow-y-auto shadow-lg">
                            <div class="p-2">
                                @for (camera of allCameras(); track camera.id) {
                                <label class="flex items-center space-x-2 py-1 cursor-pointer">
                                    <input type="checkbox" [value]="camera.ipAddress"
                                        (change)="toggleCamera(camera.ipAddress, $event)"
                                        [checked]="selected_camera.rtsp.includes(camera.ipAddress)"
                                        class="w-4 h-4 text-amber-500 border-gray-300 rounded focus:ring-amber-500" />
                                    <span class="text-sm">{{ camera.name }}</span>
                                </label>
                                }
                            </div>
                        </div>
                        }
                    </div>

                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Бренд</label><select
                            [(ngModel)]="selected_data.brandId"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none text-sm">
                            <option value="">Выберите бренд</option>
                            @for (brand of allBrands(); track brand.id) {
                            <option value="{{brand.id}}">{{brand.name}}</option>
                            }
                        </select></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Вид</label><select
                            [(ngModel)]="selected_data.typeId"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none text-sm">
                            @for (type of allTypes(); track type.id) {
                            <option value="{{type.id}}">{{type.name}}</option>
                            }
                        </select></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Сорт</label>
                        <select [(ngModel)]="selected_data.sortId"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none text-sm">
                            @for (sort of allSorts(); track sort.id) {
                            <option value="{{sort.id}}">{{sort.name}}</option>
                            }
                        </select>
                    </div>
                </div>
            </div>
            }


            @if (creatingCycle && activeCycle) {
            <div class="bg-green-50 border-2 border-green-200 rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="bg-green-600 rounded-full p-2"><svg width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-clock w-6 h-6 text-white animate-pulse">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg></div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">{{newCycle.cycleName}}</h3>
                            <div class="flex gap-4 mt-1 text-sm text-gray-600">
                                <div><span class="font-medium">Начало:</span> {{ newCycle.startTime |
                                    date:'dd.MM.yyyy,HH:mm:ss' }}</div>
                                <div><span class="font-medium">Длительность:</span> {{newCycle.duration}}</div>
                                <div><span class="font-medium">Подсчитано:</span>
                                    <span class="text-green-700 font-bold"> {{totalBags}} мешков</span>
                                </div>
                            </div>
                        </div>
                    </div><button (click)="stopCycle()"
                        class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors flex items-center gap-2"><svg
                            width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-stop-circle w-5 h-5">
                            <circle cx="12" cy="12" r="10"></circle>
                            <rect width="6" height="6" x="9" y="9"></rect>
                        </svg>Завершить цикл</button>
                </div>
            </div>
            }












            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center gap-3 mb-4">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-history w-6 h-6 text-amber-600">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                        <path d="M3 3v5h5"></path>
                        <path d="M12 7v5l4 2"></path>
                    </svg>
                    <h2 class="text-xl font-bold text-gray-800">История циклов</h2>
                </div>
                @for (cycle of allCycles(); track cycle.id) {
                <div class="space-y-3 p-2">
                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                        <button (click)="cyclesTableState[cycle.id] = !cyclesTableState[cycle.id]"
                            class="w-full px-4 py-4 bg-gray-50 hover:bg-gray-100 transition-colors flex items-center justify-between"
                            fdprocessedid="jevji5">
                            <div class="flex items-center gap-4 text-left">
                                <div><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                        class="lucide lucide-chevron-down w-5 h-5 text-gray-600">
                                        <path d="m6 9 6 6 6-6"></path>
                                    </svg></div>
                                <div>
                                    <h3 class="font-semibold text-gray-800">{{ cycle.name }}</h3>
                                    <div class="flex gap-4 mt-1 text-sm text-gray-600"><span>{{
                                            newCycle.startTime | date:'dd.MM.yyyy' }}-{{ newCycle.endTime |
                                            date:'dd.MM.yyyy' }}</span><span>Длительность: {{ cycle.duration
                                            }}</span><span class="font-semibold text-amber-600">Всего: {{ cycle.total }}
                                            мешков</span>
                                    </div>
                                </div>
                            </div>
                        </button>
                        @if (cyclesTableState[cycle.id]){
                        <div class="p-4 bg-white">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="border-b border-gray-200">
                                            <th class="px-3 py-2 text-left font-semibold text-gray-700">Камера</th>
                                            <th class="px-3 py-2 text-left font-semibold text-gray-700">Бренд</th>
                                            <th class="px-3 py-2 text-left font-semibold text-gray-700">Вид</th>
                                            <th class="px-3 py-2 text-left font-semibold text-gray-700">Сорт</th>
                                            <th class="px-3 py-2 text-left font-semibold text-gray-700">Кол-во</th>
                                            <th class="px-3 py-2 text-left font-semibold text-gray-700">Время</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for(cam of cycle.cameraData; track cam.id){
                                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                                            <td class="px-3 py-2 text-gray-800">{{ cam.camera.name}}</td>
                                            <td class="px-3 py-2 text-gray-800">{{ cam.brand.name }}</td>
                                            <td class="px-3 py-2 text-gray-800">{{ cam.type.name }}</td>
                                            <td class="px-3 py-2 text-gray-800">{{ cam.sort.name }}</td>
                                            <td class="px-3 py-2 text-amber-600 font-semibold">{{ cam.count }}</td>
                                            <td class="px-3 py-2 text-gray-600 text-xs">{{ newCycle.startTime |
                                                date:'HH:mm:ss' }}</td>
                                        </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        }
                    </div>
                </div>
                }
            </div>
        </div>
    </div>
</div>